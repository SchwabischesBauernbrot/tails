#!/bin/bash

set -eu
set -x

usage() {
    echo "Usage:"
    echo "  Check the entire codebase:"
    echo "   $0"
    echo "  Check Python files changed since REF"
    echo "   $0 REF"
    echo "  Pass additional options to ruff:"
    echo "   $0 REF --output-format=junit"
}

conf="$(dirname "$0")/ruff.toml"

if [ "$#" -eq 0 ]; then
    ruff "--config=$conf" check .
    exit $?
elif [ "$#" -lt 1 ]; then
    echo "Unsupported usage" >&2
    usage >&2
    exit 2
fi

REF="$(git rev-parse "$1")"
shift 1

is_python_file() {
  local file="$1"
  if [ ! -f "${file}" ]; then
    return 1
  fi
  if [[ "${file}" == *.py ]]; then
    return 0
  fi
  if file --brief --keep-going -E --mime-type "${file}" | grep -q 'text/x-script.python'; then
    return 0
  fi
  return 1
}

changed_files=$(git diff --name-only "${REF}")
untracked_files=$(git ls-files --others --exclude-standard)
all_files="${changed_files}"$'\n'"${untracked_files}"

# Remove the trailing newline (if any)
all_files="${all_files%$'\n'}"

files_to_check=""
while IFS= read -r file; do
    if is_python_file "${file}"; then
        files_to_check="${files_to_check}${file}"$'\n'
    fi
done <<< "${all_files}"

# Remove the trailing newline (if any)
files_to_check="${files_to_check%$'\n'}"

if [ -z "${files_to_check}" ]; then
    exit 0
fi

echo "${files_to_check}" | xargs -d '\n' ruff "--config=$conf" "$@"
